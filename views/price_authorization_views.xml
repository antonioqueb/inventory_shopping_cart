<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista List -->
    <record id="price_authorization_tree_view" model="ir.ui.view">
        <field name="name">price.authorization.list</field>
        <field name="model">price.authorization</field>
        <field name="arch" type="xml">
            <list decoration-info="state=='pending'" decoration-success="state=='approved'" decoration-danger="state=='rejected'">
                <field name="name"/>
                <field name="seller_id"/>
                <field name="operation_type"/>
                <field name="partner_id"/>
                <field name="currency_code"/>
                <field name="sale_order_id"/>
                <field name="create_date"/>
                <field name="state" widget="badge" decoration-info="state=='pending'" decoration-success="state=='approved'" decoration-danger="state=='rejected'"/>
            </list>
        </field>
    </record>
    
    <!-- Vista Form -->
    <record id="price_authorization_form_view" model="ir.ui.view">
        <field name="name">price.authorization.form</field>
        <field name="model">price.authorization</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_approve" string="Aprobar" type="object" class="btn-success" 
                            invisible="state != 'pending'" groups="inventory_shopping_cart.group_price_authorizer"/>
                    <button name="action_reject" string="Rechazar" type="object" class="btn-danger" 
                            invisible="state != 'pending'" groups="inventory_shopping_cart.group_price_authorizer"/>
                    <field name="state" widget="statusbar" statusbar_visible="pending,approved,rejected"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="%(sale.act_res_partner_2_sale_order)d" type="action" class="oe_stat_button" icon="fa-shopping-cart" 
                                invisible="not sale_order_id" context="{'search_default_order_id': sale_order_id}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Ver</span>
                                <span class="o_stat_text">Orden</span>
                            </div>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <h1><field name="name" readonly="1"/></h1>
                    </div>
                    
                    <div class="alert alert-success" invisible="state != 'approved' or not sale_order_id">
                        <i class="fa fa-check-circle me-2"></i>
                        <strong>Orden Generada:</strong>
                        <field name="sale_order_id" readonly="1"/>
                    </div>
                    
                    <group>
                        <group>
                            <field name="seller_id" readonly="1"/>
                            <field name="operation_type" readonly="1"/>
                            <field name="partner_id" readonly="1"/>
                            <field name="project_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="currency_code" readonly="1"/>
                            <field name="create_date" readonly="1"/>
                            <field name="authorizer_id" readonly="1"/>
                            <field name="authorization_date" readonly="1"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Productos Solicitados">
                            <field name="line_ids" readonly="state != 'pending'">
                                <list decoration-danger="price_level=='below_minimum'" decoration-warning="price_level=='minimum'" editable="bottom">
                                    <field name="product_id" readonly="1"/>
                                    <field name="quantity" readonly="1"/>
                                    <field name="lot_count" readonly="1"/>
                                    
                                    <!-- ✅ COLUMNAS VISIBLES SOLO PARA AUTORIZADORES -->
                                    <field name="medium_price" groups="inventory_shopping_cart.group_price_authorizer" readonly="1"/>
                                    <field name="minimum_price" groups="inventory_shopping_cart.group_price_authorizer" readonly="1"/>
                                    
                                    <!-- ✅ PRECIO SOLICITADO POR EL VENDEDOR (SIEMPRE VISIBLE Y READONLY) -->
                                    <field name="requested_price" string="Precio Prometido" readonly="1" 
                                           decoration-danger="price_level=='below_minimum'" 
                                           decoration-warning="price_level=='minimum'"/>
                                    
                                    <!-- ✅ PRECIO AUTORIZADO (EDITABLE SOLO EN PENDIENTE) -->
                                    <field name="authorized_price" string="Precio Autorizado" 
                                           readonly="parent.state != 'pending'" 
                                           decoration-success="authorized_price >= medium_price"
                                           decoration-warning="authorized_price &lt; medium_price and authorized_price >= minimum_price"
                                           decoration-danger="authorized_price &lt; minimum_price"/>
                                    
                                    <field name="price_level" invisible="1"/>
                                </list>
                            </field>
                            
                            <!-- ✅ AYUDA VISUAL PARA EL AUTORIZADOR -->
                            <div class="alert alert-info mt-3" invisible="state != 'pending'" groups="inventory_shopping_cart.group_price_authorizer">
                                <h6><i class="fa fa-info-circle me-2"></i>Guía de Precios</h6>
                                <ul class="mb-0">
                                    <li><strong>Precio Prometido:</strong> Es el precio que el vendedor ofreció al cliente</li>
                                    <li><strong>Precio Autorizado:</strong> Puede modificarlo si lo considera necesario</li>
                                    <li class="text-success">✓ Verde: Precio igual o mayor al medio</li>
                                    <li class="text-warning">⚠ Amarillo: Precio entre mínimo y medio</li>
                                    <li class="text-danger">✗ Rojo: Precio debajo del mínimo</li>
                                </ul>
                            </div>
                        </page>
                        
                        <page string="Notas">
                            <group>
                                <field name="notes" readonly="1"/>
                                <field name="authorization_notes" readonly="state != 'pending'" groups="inventory_shopping_cart.group_price_authorizer"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>
    
    <!-- Acción -->
    <record id="action_price_authorization" model="ir.actions.act_window">
        <field name="name">Autorizaciones de Precio</field>
        <field name="res_model">price.authorization</field>
        <field name="view_mode">list,form</field>
        <field name="context">{'search_default_pending': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay solicitudes de autorización de precios
            </p>
        </field>
    </record>
    
    <!-- Filtros de búsqueda -->
    <record id="price_authorization_search_view" model="ir.ui.view">
        <field name="name">price.authorization.search</field>
        <field name="model">price.authorization</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="seller_id"/>
                <field name="partner_id"/>
                <filter name="pending" string="Pendientes" domain="[('state','=','pending')]"/>
                <filter name="approved" string="Aprobados" domain="[('state','=','approved')]"/>
                <filter name="rejected" string="Rechazados" domain="[('state','=','rejected')]"/>
                <filter name="group_seller" string="Vendedor" context="{'group_by': 'seller_id'}"/>
                <filter name="group_state" string="Estado" context="{'group_by': 'state'}"/>
            </search>
        </field>
    </record>
    
    <!-- Menú -->
    <menuitem id="menu_price_authorizations" name="Autorizaciones de Precio" 
              parent="sale.sale_order_menu" action="action_price_authorization" 
              groups="inventory_shopping_cart.group_price_authorizer,inventory_shopping_cart.group_seller" 
              sequence="30"/>
</odoo>