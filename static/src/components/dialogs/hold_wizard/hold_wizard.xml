<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <t t-name="inventory_shopping_cart.HoldWizard" owl="1">
        <Dialog size="'lg'">
            <div class="hold-wizard-content">
                <!-- Header con total de lotes -->
                <div class="alert alert-light border-start border-4 border-secondary mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-lock fa-2x text-secondary me-3"></i>
                        <div>
                            <h5 class="mb-1 fw-bold">Apartado Múltiple</h5>
                            <small class="text-muted">
                                <i class="fa fa-cubes me-1"></i>
                                <strong t-esc="props.selectedLots.length"></strong> lotes seleccionados
                            </small>
                        </div>
                    </div>
                </div>
                
                <!-- Indicador de pasos -->
                <div class="steps-indicator mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 1, completed: state.currentStep > 1 }">
                            <div class="step-number">1</div>
                            <div class="step-label">Cliente</div>
                        </div>
                        <div class="step-line" t-att-class="{ active: state.currentStep > 1 }"></div>
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 2, completed: state.currentStep > 2 }">
                            <div class="step-number">2</div>
                            <div class="step-label">Proyecto</div>
                        </div>
                        <div class="step-line" t-att-class="{ active: state.currentStep > 2 }"></div>
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 3, completed: state.currentStep > 3 }">
                            <div class="step-number">3</div>
                            <div class="step-label">Arquitecto</div>
                        </div>
                        <div class="step-line" t-att-class="{ active: state.currentStep > 3 }"></div>
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 4, completed: state.currentStep > 4 }">
                            <div class="step-number">4</div>
                            <div class="step-label">Precios</div>
                        </div>
                        <div class="step-line" t-att-class="{ active: state.currentStep > 4 }"></div>
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 5 }">
                            <div class="step-number">5</div>
                            <div class="step-label">Confirmar</div>
                        </div>
                    </div>
                </div>
                
                <!-- PASO 1: CLIENTE -->
                <div class="step-content" t-if="state.currentStep === 1">
                    <h5 class="mb-3">
                        <i class="fa fa-user text-secondary me-2"></i>
                        Seleccionar Cliente
                    </h5>
                    
                    <div class="btn-group w-100 mb-3" role="group">
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="!state.showCreatePartner ? 'btn-secondary' : 'btn-outline-secondary'"
                            t-on-click="() => this.state.showCreatePartner = false"
                        >
                            <i class="fa fa-search me-2"></i>
                            Buscar Existente
                        </button>
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="state.showCreatePartner ? 'btn-secondary' : 'btn-outline-secondary'"
                            t-on-click="toggleCreatePartner"
                        >
                            <i class="fa fa-plus me-2"></i>
                            Crear Nuevo
                        </button>
                    </div>
                    
                    <t t-if="!state.showCreatePartner">
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="fa fa-search"></i>
                            </span>
                            <input 
                                type="text"
                                class="form-control"
                                placeholder="Buscar por nombre, RFC o referencia..."
                                t-model="state.searchPartnerTerm"
                                t-on-input="onSearchPartner"
                            />
                        </div>
                        
                        <div class="alert alert-light border d-flex align-items-center mb-3" t-if="state.selectedPartnerName">
                            <i class="fa fa-check-circle fa-2x text-success me-3"></i>
                            <div>
                                <strong>Cliente seleccionado:</strong><br/>
                                <t t-esc="state.selectedPartnerName"/>
                            </div>
                        </div>
                        
                        <div class="list-group" style="max-height: 300px; overflow-y: auto;" t-if="state.partners.length > 0 and !state.selectedPartnerName">
                            <t t-foreach="state.partners" t-as="partner" t-key="partner.id">
                                <button 
                                    type="button"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    t-on-click="() => this.selectPartner(partner)"
                                >
                                    <div>
                                        <strong t-esc="partner.name"></strong>
                                        <small class="text-muted ms-2" t-if="partner.ref">
                                            [<t t-esc="partner.ref"/>]
                                        </small>
                                        <small class="text-muted ms-2" t-if="partner.vat">
                                            RFC: <t t-esc="partner.vat"/>
                                        </small>
                                    </div>
                                    <i class="fa fa-chevron-right text-muted"></i>
                                </button>
                            </t>
                        </div>
                    </t>
                    
                    <t t-if="state.showCreatePartner">
                        <div class="card bg-light border mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        Nombre del Cliente <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="text"
                                        class="form-control"
                                        placeholder="Nombre completo o razón social..."
                                        t-model="state.newPartnerName"
                                    />
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">RFC (opcional)</label>
                                        <input 
                                            type="text"
                                            class="form-control"
                                            placeholder="RFC..."
                                            t-model="state.newPartnerVat"
                                        />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Referencia (opcional)</label>
                                        <input 
                                            type="text"
                                            class="form-control"
                                            placeholder="Código de referencia..."
                                            t-model="state.newPartnerRef"
                                        />
                                    </div>
                                </div>
                                <button 
                                    class="btn btn-secondary w-100"
                                    t-on-click="createPartner"
                                >
                                    <i class="fa fa-plus-circle me-2"></i>
                                    Crear Cliente
                                </button>
                            </div>
                        </div>
                    </t>
                </div>
                
                <!-- PASO 2: PROYECTO -->
                <div class="step-content" t-if="state.currentStep === 2">
                    <h5 class="mb-3">
                        <i class="fa fa-folder text-secondary me-2"></i>
                        Seleccionar Proyecto
                    </h5>
                    
                    <div class="btn-group w-100 mb-3" role="group">
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="!state.showCreateProject ? 'btn-secondary' : 'btn-outline-secondary'"
                            t-on-click="() => this.state.showCreateProject = false"
                        >
                            <i class="fa fa-search me-2"></i>
                            Buscar Existente
                        </button>
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="state.showCreateProject ? 'btn-secondary' : 'btn-outline-secondary'"
                            t-on-click="toggleCreateProject"
                        >
                            <i class="fa fa-plus me-2"></i>
                            Crear Nuevo
                        </button>
                    </div>
                    
                    <t t-if="!state.showCreateProject">
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="fa fa-search"></i>
                            </span>
                            <input 
                                type="text"
                                class="form-control"
                                placeholder="Buscar proyecto..."
                                t-model="state.searchProjectTerm"
                                t-on-input="onSearchProject"
                            />
                        </div>
                        
                        <div class="alert alert-light border d-flex align-items-center mb-3" t-if="state.selectedProjectName">
                            <i class="fa fa-check-circle fa-2x text-success me-3"></i>
                            <div>
                                <strong>Proyecto seleccionado:</strong><br/>
                                <t t-esc="state.selectedProjectName"/>
                            </div>
                        </div>
                        
                        <div class="list-group" style="max-height: 300px; overflow-y: auto;" t-if="state.projects.length > 0 and !state.selectedProjectName">
                            <t t-foreach="state.projects" t-as="project" t-key="project.id">
                                <button 
                                    type="button"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    t-on-click="() => this.selectProject(project)"
                                >
                                    <div>
                                        <strong t-esc="project.name"></strong>
                                    </div>
                                    <i class="fa fa-chevron-right text-muted"></i>
                                </button>
                            </t>
                        </div>
                    </t>
                    
                    <t t-if="state.showCreateProject">
                        <div class="card bg-light border mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        Nombre del Proyecto <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="text"
                                        class="form-control"
                                        placeholder="Nombre del proyecto..."
                                        t-model="state.newProjectName"
                                    />
                                </div>
                                <button 
                                    class="btn btn-secondary w-100"
                                    t-on-click="createProject"
                                >
                                    <i class="fa fa-plus-circle me-2"></i>
                                    Crear Proyecto
                                </button>
                            </div>
                        </div>
                    </t>
                </div>
                
                <!-- PASO 3: ARQUITECTO -->
                <div class="step-content" t-if="state.currentStep === 3">
                    <h5 class="mb-3">
                        <i class="fa fa-user-circle text-secondary me-2"></i>
                        Seleccionar Arquitecto
                    </h5>
                    
                    <div class="btn-group w-100 mb-3" role="group">
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="!state.showCreateArchitect ? 'btn-secondary' : 'btn-outline-secondary'"
                            t-on-click="() => this.state.showCreateArchitect = false"
                        >
                            <i class="fa fa-search me-2"></i>
                            Buscar Existente
                        </button>
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="state.showCreateArchitect ? 'btn-secondary' : 'btn-outline-secondary'"
                            t-on-click="toggleCreateArchitect"
                        >
                            <i class="fa fa-plus me-2"></i>
                            Crear Nuevo
                        </button>
                    </div>
                    
                    <t t-if="!state.showCreateArchitect">
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="fa fa-search"></i>
                            </span>
                            <input 
                                type="text"
                                class="form-control"
                                placeholder="Buscar arquitecto..."
                                t-model="state.searchArchitectTerm"
                                t-on-input="onSearchArchitect"
                            />
                        </div>
                        
                        <div class="alert alert-light border d-flex align-items-center mb-3" t-if="state.selectedArchitectName">
                            <i class="fa fa-check-circle fa-2x text-success me-3"></i>
                            <div>
                                <strong>Arquitecto seleccionado:</strong><br/>
                                <t t-esc="state.selectedArchitectName"/>
                            </div>
                        </div>
                        
                        <div class="list-group" style="max-height: 300px; overflow-y: auto;" t-if="state.architects.length > 0 and !state.selectedArchitectName">
                            <t t-foreach="state.architects" t-as="architect" t-key="architect.id">
                                <button 
                                    type="button"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    t-on-click="() => this.selectArchitect(architect)"
                                >
                                    <div>
                                        <strong t-esc="architect.name"></strong>
                                        <small class="text-muted ms-2" t-if="architect.ref">
                                            [<t t-esc="architect.ref"/>]
                                        </small>
                                        <small class="text-muted ms-2" t-if="architect.vat">
                                            RFC: <t t-esc="architect.vat"/>
                                        </small>
                                    </div>
                                    <i class="fa fa-chevron-right text-muted"></i>
                                </button>
                            </t>
                        </div>
                    </t>
                    
                    <t t-if="state.showCreateArchitect">
                        <div class="card bg-light border mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        Nombre del Arquitecto <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="text"
                                        class="form-control"
                                        placeholder="Nombre completo..."
                                        t-model="state.newArchitectName"
                                    />
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">RFC (opcional)</label>
                                        <input 
                                            type="text"
                                            class="form-control"
                                            placeholder="RFC..."
                                            t-model="state.newArchitectVat"
                                        />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Referencia (opcional)</label>
                                        <input 
                                            type="text"
                                            class="form-control"
                                            placeholder="Código de referencia..."
                                            t-model="state.newArchitectRef"
                                        />
                                    </div>
                                </div>
                                <button 
                                    class="btn btn-secondary w-100"
                                    t-on-click="createArchitect"
                                >
                                    <i class="fa fa-plus-circle me-2"></i>
                                    Crear Arquitecto
                                </button>
                            </div>
                        </div>
                    </t>
                </div>
                
                <!-- PASO 4: PRECIOS -->
                <div class="step-content" t-if="state.currentStep === 4">
                    <h5 class="mb-3">
                        <i class="fa fa-dollar text-secondary me-2"></i>
                        Configurar Precios
                    </h5>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Divisa *</label>
                        <select class="form-select" t-model="state.selectedCurrency" t-on-change="onCurrencyChange">
                            <option value="USD">USD - Dólares</option>
                            <option value="MXN">MXN - Pesos</option>
                        </select>
                    </div>
                    
                    <t t-foreach="Object.entries(props.productGroups)" t-as="entry" t-key="entry[0]">
                        <t t-set="productId" t-value="entry[0]"/>
                        <t t-set="group" t-value="entry[1]"/>
                        
                        <div class="card border mb-3">
                            <div class="card-body">
                                <h6><t t-esc="group.name"/></h6>
                                <small class="text-muted">
                                    <t t-esc="formatNumber(group.total_quantity)"/> m² • 
                                    <t t-esc="group.lots.length"/> lotes
                                </small>
                                
                                <div class="mt-3">
                                    <label class="form-label">Precio por m² *</label>
                                    <t t-if="state.productPriceOptions[productId] and state.productPriceOptions[productId].length > 0">
                                        <select 
                                            class="form-select mb-2"
                                            t-model.number="state.productPrices[productId]"
                                            t-on-change="(ev) => this.onPriceChange(productId, ev.target.value)"
                                        >
                                            <t t-foreach="state.productPriceOptions[productId]" t-as="option" t-key="option_index">
                                                <option t-att-value="option.value">
                                                    <t t-esc="option.label"/> - <t t-esc="formatNumber(option.value)"/>
                                                </option>
                                            </t>
                                        </select>
                                    </t>
                                    <input 
                                        type="number"
                                        class="form-control"
                                        placeholder="Precio personalizado"
                                        t-model.number="state.productPrices[productId]"
                                        t-on-change="(ev) => this.onPriceChange(productId, ev.target.value)"
                                        step="0.01"
                                    />
                                </div>
                            </div>
                        </div>
                    </t>
                </div>
                
                <!-- PASO 5: CONFIRMAR -->
                <div class="step-content" t-if="state.currentStep === 5">
                    <h5 class="mb-3">
                        <i class="fa fa-check-circle text-success me-2"></i>
                        Confirmar Apartados
                    </h5>
                    
                    <div class="card border mb-3">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Resumen</h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <strong>Cliente:</strong><br/>
                                    <t t-esc="state.selectedPartnerName"/>
                                </div>
                                <div class="col-md-6">
                                    <strong>Proyecto:</strong><br/>
                                    <t t-esc="state.selectedProjectName"/>
                                </div>
                                <div class="col-md-6">
                                    <strong>Arquitecto:</strong><br/>
                                    <t t-esc="state.selectedArchitectName"/>
                                </div>
                                <div class="col-md-6">
                                    <strong>Vendedor:</strong><br/>
                                    <span class="badge bg-info text-dark">
                                        <i class="fa fa-user me-1"></i>
                                        <t t-esc="state.sellerName"/>
                                    </span>
                                </div>
                                <div class="col-md-6">
                                    <strong>Divisa:</strong><br/>
                                    <t t-esc="state.selectedCurrency"/>
                                </div>
                                <div class="col-md-6">
                                    <strong>Total de lotes:</strong><br/>
                                    <t t-esc="props.selectedLots.length"/>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card border mb-3">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Precios Configurados</h6>
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-end">Cantidad</th>
                                        <th class="text-end">Precio/m²</th>
                                        <th class="text-end">Total Estimado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="Object.entries(props.productGroups)" t-as="entry" t-key="entry[0]">
                                        <t t-set="productId" t-value="entry[0]"/>
                                        <t t-set="group" t-value="entry[1]"/>
                                        <tr>
                                            <td><t t-esc="group.name"/></td>
                                            <td class="text-end"><t t-esc="formatNumber(group.total_quantity)"/> m²</td>
                                            <td class="text-end"><t t-esc="formatNumber(state.productPrices[productId])"/> <t t-esc="state.selectedCurrency"/></td>
                                            <td class="text-end"><t t-esc="formatNumber(group.total_quantity * state.productPrices[productId])"/> <t t-esc="state.selectedCurrency"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fa fa-commenting text-secondary me-2"></i>
                            Notas (opcional)
                        </label>
                        <textarea 
                            class="form-control"
                            rows="3"
                            placeholder="Observaciones adicionales..."
                            t-model="state.notas"
                        ></textarea>
                    </div>
                    
                    <div class="alert alert-light border">
                        <div class="d-flex align-items-start">
                            <i class="fa fa-clock-o fa-2x text-muted me-3"></i>
                            <div>
                                <strong class="d-block mb-1">Duración del Apartado</strong>
                                <p class="mb-0">
                                    Los apartados tendrán una duración de <strong>5 días hábiles</strong> a partir de hoy.
                                    Podrás renovarlos desde la gestión de apartados si es necesario.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <t t-set-slot="footer">
                <button 
                    class="btn btn-light border btn-lg"
                    t-on-click="prevStep"
                    t-if="state.currentStep > 1 and state.currentStep &lt; 5"
                >
                    <i class="fa fa-chevron-left me-2"></i>
                    Anterior
                </button>
                
                <button 
                    class="btn btn-light border btn-lg"
                    t-on-click="props.close"
                    t-if="state.currentStep === 1"
                >
                    <i class="fa fa-times me-2"></i>
                    Cancelar
                </button>
                
                <button 
                    class="btn btn-secondary btn-lg"
                    t-on-click="nextStep"
                    t-if="state.currentStep &lt; 5"
                >
                    Siguiente
                    <i class="fa fa-chevron-right ms-2"></i>
                </button>
                
                <button 
                    class="btn btn-light border btn-lg"
                    t-on-click="prevStep"
                    t-if="state.currentStep === 5"
                >
                    <i class="fa fa-chevron-left me-2"></i>
                    Anterior
                </button>
                
                <button 
                    class="btn btn-primary btn-lg"
                    t-on-click="createHolds"
                    t-if="state.currentStep === 5"
                    t-att-disabled="state.isCreating"
                >
                    <t t-if="!state.isCreating">
                        <i class="fa fa-lock me-2"></i>
                        Apartar Todo
                    </t>
                    <t t-else="">
                        <i class="fa fa-spinner fa-spin me-2"></i>
                        Apartando...
                    </t>
                </button>
            </t>
        </Dialog>
    </t>
    
</templates>