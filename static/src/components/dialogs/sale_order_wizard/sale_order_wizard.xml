<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <t t-name="inventory_shopping_cart.SaleOrderWizard" owl="1">
        <Dialog size="'lg'">
            <div class="sale-order-wizard-content">
                <div class="alert alert-light border-start border-4 border-primary mb-4">
                    <div class="d-flex align-items-center">
                        <i class="fa fa-file-text fa-2x text-primary me-3"></i>
                        <div>
                            <h5 class="mb-1 fw-bold">Crear Orden de Venta</h5>
                            <small class="text-muted">
                                <i class="fa fa-cubes me-1"></i>
                                <strong t-esc="totalProducts"></strong> productos en el carrito
                            </small>
                        </div>
                    </div>
                </div>
                
                <div class="steps-indicator mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 1, completed: state.currentStep > 1 }">
                            <div class="step-number">1</div>
                            <div class="step-label">Cliente</div>
                        </div>
                        <div class="step-line" t-att-class="{ active: state.currentStep > 1 }"></div>
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 2, completed: state.currentStep > 2 }">
                            <div class="step-number">2</div>
                            <div class="step-label">Precios</div>
                        </div>
                        <div class="step-line" t-att-class="{ active: state.currentStep > 2 }"></div>
                        <div class="step-item" t-att-class="{ active: state.currentStep >= 3 }">
                            <div class="step-number">3</div>
                            <div class="step-label">Confirmar</div>
                        </div>
                    </div>
                </div>
                
                <!-- PASO 1: CLIENTE -->
                <div class="step-content" t-if="state.currentStep === 1">
                    <h5 class="mb-3">
                        <i class="fa fa-user text-primary me-2"></i>
                        Seleccionar Cliente
                    </h5>
                    
                    <div class="btn-group w-100 mb-3" role="group">
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="!state.showCreatePartner ? 'btn-primary' : 'btn-outline-primary'"
                            t-on-click="() => this.state.showCreatePartner = false"
                        >
                            <i class="fa fa-search me-2"></i>
                            Buscar Existente
                        </button>
                        <button 
                            type="button" 
                            class="btn"
                            t-att-class="state.showCreatePartner ? 'btn-primary' : 'btn-outline-primary'"
                            t-on-click="toggleCreatePartner"
                        >
                            <i class="fa fa-plus me-2"></i>
                            Crear Nuevo
                        </button>
                    </div>
                    
                    <t t-if="!state.showCreatePartner">
                        <div class="input-group mb-2">
                            <span class="input-group-text">
                                <i class="fa fa-search"></i>
                            </span>
                            <input 
                                type="text"
                                class="form-control"
                                placeholder="Buscar por nombre, RFC o referencia..."
                                t-model="state.searchPartnerTerm"
                                t-on-input="onSearchPartner"
                            />
                        </div>
                        
                        <div class="alert alert-light border d-flex align-items-center mb-3" t-if="state.selectedPartnerName">
                            <i class="fa fa-check-circle fa-2x text-success me-3"></i>
                            <div>
                                <strong>Cliente seleccionado:</strong><br/>
                                <t t-esc="state.selectedPartnerName"/>
                            </div>
                        </div>
                        
                        <div class="list-group" style="max-height: 300px; overflow-y: auto;" t-if="state.partners.length > 0 and !state.selectedPartnerName">
                            <t t-foreach="state.partners" t-as="partner" t-key="partner.id">
                                <button 
                                    type="button"
                                    class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                                    t-on-click="() => this.selectPartner(partner)"
                                >
                                    <div>
                                        <strong t-esc="partner.name"></strong>
                                        <small class="text-muted ms-2" t-if="partner.ref">
                                            [<t t-esc="partner.ref"/>]
                                        </small>
                                        <small class="text-muted ms-2" t-if="partner.vat">
                                            RFC: <t t-esc="partner.vat"/>
                                        </small>
                                    </div>
                                    <i class="fa fa-chevron-right text-muted"></i>
                                </button>
                            </t>
                        </div>
                    </t>
                    
                    <t t-if="state.showCreatePartner">
                        <div class="card bg-light border mb-3">
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        Nombre del Cliente <span class="text-danger">*</span>
                                    </label>
                                    <input 
                                        type="text"
                                        class="form-control"
                                        placeholder="Nombre completo o razón social..."
                                        t-model="state.newPartnerName"
                                    />
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">RFC (opcional)</label>
                                        <input 
                                            type="text"
                                            class="form-control"
                                            placeholder="RFC..."
                                            t-model="state.newPartnerVat"
                                        />
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Referencia (opcional)</label>
                                        <input 
                                            type="text"
                                            class="form-control"
                                            placeholder="Código de referencia..."
                                            t-model="state.newPartnerRef"
                                        />
                                    </div>
                                </div>
                                <button 
                                    class="btn btn-primary w-100"
                                    t-on-click="createPartner"
                                >
                                    <i class="fa fa-plus-circle me-2"></i>
                                    Crear Cliente
                                </button>
                            </div>
                        </div>
                    </t>
                </div>
                
                <!-- PASO 2: PRECIOS POR PRODUCTO -->
                <div class="step-content" t-if="state.currentStep === 2">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fa fa-dollar text-primary me-2"></i>
                            Configurar Precio
                        </h5>
                        <span class="badge bg-secondary">
                            Producto <t t-esc="currentProductIndex + 1"/> de <t t-esc="totalProducts"/>
                        </span>
                    </div>
                    
                    <!-- Producto Actual -->
                    <div class="card border-primary mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">
                                <i class="fa fa-cube me-2"></i>
                                <t t-esc="currentProductGroup.name"/>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <strong>Cantidad total:</strong>
                                    <div class="text-muted">
                                        <t t-esc="formatNumber(currentProductGroup.total_quantity)"/> m²
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <strong>Lotes:</strong>
                                    <div class="text-muted">
                                        <t t-esc="currentProductGroup.lots.length"/> lotes
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Divisa / Lista de Precios *</label>
                                <select class="form-select" t-model="state.selectedCurrency" t-on-change="onCurrencyChange">
                                    <option value="USD">USD - Dólares</option>
                                    <option value="MXN">MXN - Pesos</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold">Precio por m² *</label>
                                <t t-if="state.productPriceOptions[currentProductId] and state.productPriceOptions[currentProductId].length > 0">
                                    <select 
                                        class="form-select mb-2"
                                        t-model.number="state.productPrices[currentProductId]"
                                        t-on-change="(ev) => this.onPriceChange(ev.target.value)"
                                    >
                                        <t t-foreach="state.productPriceOptions[currentProductId]" t-as="option" t-key="option_index">
                                            <option t-att-value="option.value">
                                                <t t-esc="option.label"/> - <t t-esc="formatNumber(option.value)"/>
                                            </option>
                                        </t>
                                    </select>
                                </t>
                                <input 
                                    type="number"
                                    class="form-control"
                                    placeholder="Precio personalizado"
                                    t-model.number="state.productPrices[currentProductId]"
                                    t-on-change="(ev) => this.onPriceChange(ev.target.value)"
                                    step="0.01"
                                />
                            </div>
                            
                            <div class="alert alert-light border">
                                <strong>Total estimado:</strong>
                                <div class="h4 mb-0 text-primary">
                                    <t t-esc="formatNumber(currentProductGroup.total_quantity * (state.productPrices[currentProductId] || 0))"/>
                                    <small><t t-esc="state.selectedCurrency"/></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Navegación entre productos -->
                    <div class="d-flex justify-content-between mt-3">
                        <button 
                            class="btn btn-outline-secondary"
                            t-on-click="prevProduct"
                            t-att-disabled="isFirstProduct"
                        >
                            <i class="fa fa-chevron-left me-2"></i>
                            Anterior Producto
                        </button>
                        
                        <button 
                            class="btn btn-primary"
                            t-on-click="nextProduct"
                            t-if="!isLastProduct"
                        >
                            Siguiente Producto
                            <i class="fa fa-chevron-right ms-2"></i>
                        </button>
                        
                        <span class="btn btn-success" t-if="isLastProduct">
                            <i class="fa fa-check me-2"></i>
                            Todos los precios configurados
                        </span>
                    </div>
                    
                    <!-- IVA -->
                    <div class="mt-4">
                        <label class="form-label fw-bold">IVA</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" t-model="state.applyTax" id="applyTaxSwitch"/>
                            <label class="form-check-label" for="applyTaxSwitch">
                                <t t-if="state.applyTax">Aplicar IVA</t>
                                <t t-else="">Sin IVA (se agregará nota legal)</t>
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- PASO 3: CONFIRMAR -->
                <div class="step-content" t-if="state.currentStep === 3">
                    <h5 class="mb-3">
                        <i class="fa fa-check-circle text-success me-2"></i>
                        Confirmar Orden
                    </h5>
                    
                    <div class="card border mb-3">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Resumen</h6>
                            
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <strong>Cliente:</strong><br/>
                                    <t t-esc="state.selectedPartnerName"/>
                                </div>
                                <div class="col-md-6">
                                    <strong>Divisa:</strong><br/>
                                    <t t-esc="state.selectedCurrency"/>
                                </div>
                            </div>
                            
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-end">Cantidad</th>
                                        <th class="text-end">Precio Unit.</th>
                                        <th class="text-end">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="Object.entries(props.productGroups)" t-as="entry" t-key="entry[0]">
                                        <t t-set="productId" t-value="entry[0]"/>
                                        <t t-set="group" t-value="entry[1]"/>
                                        <tr>
                                            <td><t t-esc="group.name"/></td>
                                            <td class="text-end"><t t-esc="formatNumber(group.total_quantity)"/> m²</td>
                                            <td class="text-end"><t t-esc="formatNumber(state.productPrices[productId])"/></td>
                                            <td class="text-end"><t t-esc="formatNumber(group.total_quantity * state.productPrices[productId])"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fa fa-commenting text-primary me-2"></i>
                            Observaciones (opcional)
                        </label>
                        <textarea 
                            class="form-control"
                            rows="3"
                            placeholder="Observaciones adicionales..."
                            t-model="state.notas"
                        ></textarea>
                    </div>
                </div>
            </div>

            <t t-set-slot="footer">
                <button 
                    class="btn btn-light border btn-lg"
                    t-on-click="prevStep"
                    t-if="state.currentStep > 1 and state.currentStep &lt; 3"
                >
                    <i class="fa fa-chevron-left me-2"></i>
                    Anterior
                </button>
                
                <button 
                    class="btn btn-light border btn-lg"
                    t-on-click="props.close"
                    t-if="state.currentStep === 1"
                >
                    <i class="fa fa-times me-2"></i>
                    Cancelar
                </button>
                
                <button 
                    class="btn btn-primary btn-lg"
                    t-on-click="nextStep"
                    t-if="state.currentStep &lt; 3"
                >
                    Siguiente
                    <i class="fa fa-chevron-right ms-2"></i>
                </button>
                
                <button 
                    class="btn btn-light border btn-lg"
                    t-on-click="prevStep"
                    t-if="state.currentStep === 3"
                >
                    <i class="fa fa-chevron-left me-2"></i>
                    Anterior
                </button>
                
                <button 
                    class="btn btn-success btn-lg"
                    t-on-click="createSaleOrder"
                    t-if="state.currentStep === 3"
                    t-att-disabled="state.isCreating"
                >
                    <t t-if="!state.isCreating">
                        <i class="fa fa-check me-2"></i>
                        Crear Orden
                    </t>
                    <t t-else="">
                        <i class="fa fa-spinner fa-spin me-2"></i>
                        Creando...
                    </t>
                </button>
            </t>
        </Dialog>
    </t>
    
</templates>